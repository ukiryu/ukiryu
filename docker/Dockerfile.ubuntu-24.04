# Dockerfile for Ubuntu 24.04 (Noble Numbat) testing
# Uses official Ruby Ubuntu image from rubylang/ruby
# Build: docker build -f docker/Dockerfile.ubuntu-24.04 -t ukiryu-test:ubuntu-24.04 .
# Run: docker run --rm ukiryu-test:ubuntu-24.04

FROM rubylang/ruby:3.4-dev-noble

# Avoid interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install additional testing tools and shells
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    curl \
    wget \
    jq \
    ghostscript \
    imagemagick \
    ffmpeg \
    exiftool \
    libtiff-tools \
    libssl-dev \
    iputils-ping \
    inkscape \
    unzip \
    zip \
    # Shells for testing
    tcsh \
    zsh \
    fish \
    dash && \
    rm -rf /var/lib/apt/lists/*

# Install yq (mikefarah/yq)
RUN ARCH=$(uname -m) && \
    YQ_ARCH=amd64 && \
    if [ "$ARCH" = "aarch64" ]; then YQ_ARCH=arm64; fi && \
    wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/latest/download/yq_linux_${YQ_ARCH}" && \
    chmod +x /usr/local/bin/yq

WORKDIR /ukiryu

# Copy the entire application
COPY . .

# Install Bundler
RUN gem install bundler --no-document

# Install dependencies
RUN rm -f Gemfile.lock && bundle install

# Run tests by default
CMD ["bash", "-c", "rm -f /ukiryu/Gemfile.lock && cd /ukiryu && bundle install && bundle exec rspec"]
