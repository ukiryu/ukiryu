name: Linux Tests (Ubuntu)

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test-linux-ubuntu:
    runs-on: ${{ matrix.ubuntu_runners }}

    strategy:
      matrix:
        ruby-version: ['3.1', '3.4', '4.0']
        ubuntu_runners:
        - 'ubuntu-22.04'
        - 'ubuntu-24.04'
        - 'ubuntu-22.04-arm'
        - 'ubuntu-24.04-arm'

    steps:
      - uses: actions/checkout@v6

      # checkout schema repository
      - uses: actions/checkout@v6
        with:
          repository: ukiryu/schema
          path: schema

      # checkout register repository
      - uses: actions/checkout@v6
        with:
          repository: ukiryu/register
          ref: v1
          path: register

      # Only Ubuntu 24.04 and later have yq (fake yq)
      - name: Install core tools
        timeout-minutes: 15
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            imagemagick \
            ghostscript \
            jq \
            exiftool \
            unzip \
            zip \
            zsh

      - name: Install ffmpeg
        timeout-minutes: 15
        run: |
          sudo apt-get install -y --no-install-recommends ffmpeg

      - name: Install inkscape
        timeout-minutes: 15
        run: |
          sudo apt-get install -y --no-install-recommends inkscape

      - name: Install pandoc (optional)
        timeout-minutes: 10
        continue-on-error: true
        run: |
          sudo apt-get install -y --no-install-recommends pandoc || echo "pandoc not installed"

      - name: Install yq
        if: matrix.ubuntu_runners == 'ubuntu-24.04' || matrix.ubuntu_runners == 'ubuntu-24.04-arm'
        run: |
          echo "Installing yq..."
          sudo apt-get install -y yq

      - name: Verify installations
        run: |
          echo "=== Verifying installations ==="
          echo ""
          echo "Ruby:"
          ruby --version
          echo ""
          echo "ImageMagick:"
          magick --version || convert --version
          echo ""
          echo "Ghostscript:"
          gs --version
          echo ""
          echo "FFmpeg:"
          ffmpeg -version | head -n 1
          echo ""
          echo "ExifTool:"
          exiftool -ver
          echo ""
          echo "Pandoc (optional):"
          pandoc --version 2>/dev/null | head -n 1 || echo "  Not installed"
          echo ""
          echo "jq:"
          jq --version
          echo ""
          echo "Inkscape:"
          inkscape --version

      - name: Verify yq installation
        if: matrix.ubuntu_runners == 'ubuntu-24.04' || matrix.ubuntu_runners == 'ubuntu-24.04-arm'
        run: |
          echo "yq:"
          yq --version

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby-version }}
          bundler-cache: true

      - name: Run tests
        timeout-minutes: 30
        env:
          GIT_REDIRECT_STDERR: /dev/null
        run: bundle exec rake spec
