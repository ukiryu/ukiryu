name: Linux Tests (Alpine)

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test-linux-alpine:
    runs-on: ubuntu-latest
    container: ruby:${{ matrix.ruby-version }}-alpine

    strategy:
      matrix:
        ruby-version: ['3.1', '3.3', '4.0']

    steps:
      - uses: actions/checkout@v6

      # checkout schema repository
      - uses: actions/checkout@v6
        with:
          repository: ukiryu/schema
          path: schema

      # checkout register repository
      - uses: actions/checkout@v6
        with:
          repository: ukiryu/register
          ref: v1
          path: register

      - name: Install build dependencies
        timeout-minutes: 30
        run: |
          apk add --no-cache \
            build-base \
            openssl-dev \
            git \
            bash \
            zsh \
            fish \
            dash \
            tcsh \
            powershell \
            coreutils \
            imagemagick \
            ghostscript \
            ffmpeg \
            pandoc \
            jq \
            yq \
            exiftool \
            unzip \
            zip \
            inkscape

      - name: Verify installations
        run: |
          echo "=== Verifying installations ==="
          echo ""
          echo "Ruby:"
          ruby --version
          echo ""
          echo "ImageMagick:"
          magick --version || convert --version
          echo ""
          echo "Ghostscript:"
          gs --version
          echo ""
          echo "FFmpeg:"
          ffmpeg -version | head -n 1
          echo ""
          echo "ExifTool:"
          exiftool -ver
          echo ""
          echo "Pandoc:"
          pandoc --version | head -n 1
          echo ""
          echo "jq:"
          jq --version
          echo ""
          echo "yq:"
          yq --version
          echo ""
          echo "Inkscape:"
          inkscape --version

      - name: Install dependencies
        timeout-minutes: 20
        env:
          GIT_REDIRECT_STDERR: /dev/null
        run: |
          bundle install --jobs 4 --retry 3

      - name: Run tests
        timeout-minutes: 30
        env:
          GIT_REDIRECT_STDERR: /dev/null
          UKIRYU_REGISTER: ${{ github.workspace }}/register
        run: bundle exec rake spec
